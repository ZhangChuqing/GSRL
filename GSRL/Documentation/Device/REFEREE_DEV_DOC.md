# è£åˆ¤ç³»ç»Ÿé©±åŠ¨å¼€å‘æ–‡æ¡£ (Referee System Driver Docs)

ä½œè€…ï¼šå¼ æ¥šæ¸…
ç‰ˆæœ¬ï¼šv1.1.0  
æœ€åæ›´æ–°æ—¥æœŸï¼š2026-1-6

## ç‰ˆæœ¬ä¿¡æ¯ï¼ˆVersion Infoï¼‰
æœ¬æ¬¡æ›´æ–°åŒæ­¥å®˜æ–¹åè®® V1.1.0ï¼Œæ–°å¢å¯¹ é›·è¾¾æ— çº¿é“¾è·¯ï¼ˆCmdID 0x0A01~0x0A06ï¼‰ çš„è§£ææ”¯æŒï¼Œå¹¶å¯¹æ–‡æ¡£ç»“æ„è¿›è¡Œäº†ä¼˜åŒ–ã€‚
ğŸ‘‰ è¯¦ç»†æ›´æ–°æ—¥å¿—è§æ–‡æœ«ã€Šæ›´æ–°æ—¥å¿—ã€‹ã€‚

## 1. æ¦‚è¿°
æœ¬é©±åŠ¨ç”¨äºè§£æ RoboMaster è£åˆ¤ç³»ç»Ÿä¸²å£åè®®ï¼ˆV1.1.0ï¼‰ï¼Œæ”¯æŒæ•°æ®æ¥æ”¶ã€æ ¡éªŒã€è§£åŒ…åŠæ•°æ®ç»“æ„åŒ–å­˜å‚¨ã€‚

*   **é€‚ç”¨ç¡¬ä»¶**: STM32F407 (æˆ–å…¶ä»–æ”¯æŒ UART çš„ MCU)
*   **é€šä¿¡æ¥å£**: USART6 (RX: PG9, TX: PG14)
*   **æ³¢ç‰¹ç‡**: 115200, 8N1
*   **æ¥æ”¶æ–¹å¼**: DMA + ç©ºé—²ä¸­æ–­ (Idle Line Detection)

## 2. åè®®è¯´æ˜
éµå¾ª RoboMaster ä¸²å£åè®® V1.1.0 æ ‡å‡†ã€‚

### 2.1 æ•°æ®å¸§ç»“æ„
| SOF (1B) | DataLength (2B) | Seq (1B) | CRC8 (1B) | CmdID (2B) | Data (nB) | CRC16 (2B) |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 0xA5 | æ•°æ®æ®µé•¿åº¦ | åŒ…åºå· | å¸§å¤´æ ¡éªŒ | å‘½ä»¤ID | æ•°æ®å†…å®¹ | æ•´å¸§æ ¡éªŒ |

### 2.2 å…³é”®é…ç½®
*   **CRC8 åˆå§‹å€¼**: `0xFF`
*   **CRC16 åˆå§‹å€¼**: `0x0000` (æ³¨æ„ï¼šé 0xFFFFï¼Œ2024å¹´è¿™ç‰ˆå¤§ç–†ç»™çš„ç»æµ‹è¯•å‘ç°ä¸å¯¹)
*   **å¤šå­—èŠ‚åº**: Little Endian (å°ç«¯æ¨¡å¼)

## 3. æ¥å£ä½¿ç”¨

### 3.1 åˆå§‹åŒ–
åœ¨ä»»åŠ¡åˆå§‹åŒ–é˜¶æ®µè°ƒç”¨ï¼š
```cpp
// ç¼“å†²åŒºå»ºè®® >= 128 å­—èŠ‚ï¼Œé˜²æ­¢é•¿åŒ…æˆªæ–­
UART_Init(&huart6, refereeITCallback, 128);
```

### 3.2 ä¸­æ–­å›è°ƒ
åœ¨ä¸²å£ä¸­æ–­å›è°ƒå‡½æ•°ä¸­å°†æ•°æ®å–‚ç»™è§£æå™¨ï¼š
```cpp
// å®šä¹‰å…¨å±€è§£æå™¨å®ä¾‹
RefereeParser referee(RefereeLink::Main);

extern "C" void refereeITCallback(uint8_t *Buffer, uint16_t Length)
{
    for (uint16_t i = 0; i < Length; i++)
    {
        referee.onByteReceived(Buffer[i]);
    }
}
```

### 3.3 æ•°æ®è·å–
è§£æåçš„æ•°æ®å­˜å‚¨åœ¨ `RefereeInfo` ç»“æ„ä½“ä¸­ï¼Œå¯ç›´æ¥è®¿é—®ï¼š

```cpp
const RefereeInfo& info = referee.getInfo();

// 1. æ£€æŸ¥æ•°æ®æ˜¯å¦æ›´æ–°
if (info.hasRobotStatus) {
    // 2. è¯»å–å…·ä½“å­—æ®µ
    uint8_t my_id = info.robotStatus.robot_id;
    uint16_t hp = info.robotStatus.current_HP;
    float power = info.powerHeat.chassis_power;
}

// 3. æ¯”èµ›çŠ¶æ€ï¼ˆæ³¨æ„ï¼šå•æœºè°ƒè¯•æ—¶å¯èƒ½æ²¡æœ‰æ­¤åŒ…ï¼‰
if (info.hasGameStatus) {
    int stage = info.gameStatus.game_progress;
}
```

## 4. æ”¯æŒçš„æ•°æ®åŒ…åˆ—è¡¨

| Cmd ID | æè¿° | å¯¹åº”ç»“æ„ä½“ | å¤‡æ³¨ |
| :--- | :--- | :--- | :--- |
| **0x0001** | æ¯”èµ›çŠ¶æ€ | `GameStatus` | åŒ…å«å€’è®¡æ—¶ã€æ¯”èµ›é˜¶æ®µ |
| **0x0002** | æ¯”èµ›ç»“æœ | `GameResult` | èƒœè´Ÿåˆ¤å®š |
| **0x0003** | æœºå™¨äººè¡€é‡ | `GameRobotHP` | çº¢è“åŒæ–¹æ‰€æœ‰å•ä½è¡€é‡ |
| **0x0201** | æœºå™¨äººçŠ¶æ€ | `RobotStatus` | IDã€è¡€é‡ã€åŠŸç‡é™åˆ¶ã€çƒ­é‡é™åˆ¶ |
| **0x0202** | åŠŸç‡çƒ­é‡ | `PowerHeatData` | å®æ—¶åŠŸç‡ã€æªå£çƒ­é‡ |
| **0x0203** | æœºå™¨äººä½ç½® | `RobotPos` | x, y, angle |
| **0x0204** | å¢ç›ŠçŠ¶æ€ | `Buff` | è¡¥ç»™ç«™Buffã€é˜²å¾¡Buff |
| **0x0206** | ä¼¤å®³æ•°æ® | `HurtData` | è£…ç”²æ¿IDã€ä¼¤å®³ç±»å‹ |
| **0x0207** | å°„å‡»æ•°æ® | `ShootData` | å°„é€Ÿã€å¼¹ä¸¸åˆé€Ÿ |
| **0x0208** | å¼¹ä¸¸ä½™é‡ | `ProjectileAllowance` | å‰©ä½™å‘å¼¹é‡ |
| **0x0303** | å°åœ°å›¾å‘½ä»¤ | `MapCommand` | é€‰æ‰‹ç«¯ç‚¹å‡»åæ ‡ |
| **0x0304** | é”®é¼ æ•°æ® | `RemoteControl` | **ä»…å›¾ä¼ é“¾è·¯æœ‰æ•ˆ** |
| **0x0A01** | æ•Œæ–¹æœºå™¨äººä½ç½®åæ ‡ | `RadarEnemyPos` | 10Hz,ä¿¡å·å‘å°„æºâ†’é›·è¾¾ |
| **0x0A02** | æ•Œæ–¹æœºå™¨äººè¡€é‡ä¿¡æ¯ | `RadarEnemyHP` | åŒä¸Š |
| **0x0A03** | æ•Œæ–¹æœºå™¨äººå‰©ä½™å‘å¼¹é‡ | `RadarEnemyAmmo` | åŒä¸Š |
| **0x0A04** | æ•Œæ–¹é˜Ÿä¼å®è§‚çŠ¶æ€ | `RadarTeamStatus` | åŒä¸Š |
| **0x0A05** | æ•Œæ–¹æœºå™¨äººå¢ç›Šæ•ˆæœ | `RadarEnemyBuff` | åŒä¸Š |
| **0x0A06** | æ•Œæ–¹å¹²æ‰°æ³¢å¯†é’¥ | `RadarJammerKey` | åŒä¸Š |

## 5. å¸¸è§é—®é¢˜æ’æŸ¥

1.  **å®Œå…¨æ— æ•°æ®**: æ£€æŸ¥ `board_config.h` æ˜¯å¦å®šä¹‰ `USE_USART6`ï¼Œæ£€æŸ¥ RX/TX çº¿åºã€‚
2.  **æ ¡éªŒé”™è¯¯ (CRC Fail)**: ç¡®è®¤ `dvc_referee.cpp` ä¸­ `CRC16_INIT` ä¸º `0x0000`ã€‚
3.  **é•¿åº¦é”™è¯¯ (Len Mismatch)**: ç¡®è®¤ `dvc_referee.hpp` ä¸­çš„ç»“æ„ä½“å®šä¹‰æ˜¯å¦ä¸ V1.1.0 åè®®ä¸€è‡´ã€‚


## æ›´æ–°æ—¥å¿—ï¼ˆChangelogï¼‰

### v1.1.0ï¼ˆ2026-01-06ï¼‰
**æ–°å¢**
- æ–°å¢å¯¹è£åˆ¤ç³»ç»Ÿ *é›·è¾¾æ— çº¿é“¾è·¯* çš„è§£ææ”¯æŒï¼ŒåŒ…å« CmdID `0x0A01` ~ `0x0A06`ã€‚
- æ–°å¢é›·è¾¾æ•°æ®ç»“æ„ä½“ä¸å¯¹åº”è§£ææµç¨‹ã€‚

**æ–‡æ¡£**
- æ–‡æ¡£ç‰ˆæœ¬å·åŒæ­¥è‡³å®˜æ–¹åè®® V1.1.0ã€‚
- è¡¥å……é›·è¾¾é“¾è·¯è¯´æ˜ï¼Œå®Œå–„åè®®å­—æ®µè§£é‡Šã€‚
- ä¼˜åŒ–ç« èŠ‚ç»“æ„ä¸æ’ç‰ˆã€‚

**å…¼å®¹æ€§**
- ä¿æŒä¸åŸæœ‰å¸¸è§„é“¾è·¯ã€å›¾ä¼ é“¾è·¯æ¥å£å…¼å®¹ï¼Œæ— ç ´åæ€§å˜æ›´ã€‚